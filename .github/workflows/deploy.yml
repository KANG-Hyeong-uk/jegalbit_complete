name: Deploy to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            cd /home/edu04/jegalbit
            git pull origin master

            # 기존 프로세스 종료
            pkill -f "vite" || true
            pkill -f "uvicorn" || true

            # 프론트엔드 의존성 설치 및 백그라운드 실행
            cd /home/edu04/jegalbit/front
            npm install
            nohup npm run dev -- --host 0.0.0.0 > /home/edu04/jegalbit/front.log 2>&1 & disown

            # 백엔드 백그라운드 실행
            cd /home/edu04/jegalbit/backend
            nohup uvicorn app_fastapi:app --host 0.0.0.0 --port 5001 > /home/edu04/jegalbit/backend.log 2>&1 & disown

            echo "Deployment completed!"
